<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Info</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        input {
            margin: 5px;
        }
        button {
            padding: 5px 10px;
        }
        #state-container, #user-container {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #f4f4f4;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>User Info</h1>

    <div>
        <label for="host">Host:</label>
        <input type="text" id="host" placeholder="127.0.0.1" value="127.0.0.1" />

        <label for="port">Port:</label>
        <input type="text" id="port" placeholder="5006" value="5006" />

        <button id="connectBtn">Connect</button>
    </div>

    <br>

    <div>
        <label for="userId">User ID:</label>
        <input type="text" id="userId" placeholder="User ID" />
        <button id="getUserBtn">Get User Info</button>
    </div>

    <div id="nodes-container" style="display:none;">
        <h3>Current Nodes:</h3>
        <pre id="nodes"></pre>
    </div>

    <div id="user-container" style="display:none;">
        <h3>User Info:</h3>
        <pre id="user-info"></pre>
    </div>

    <div id="users-container" style="display:none;">
        <h3>Current Users:</h3>
        <pre id="users"></pre>
    </div>

    

    <script>
        let socket = null;

        const usersContainer = document.getElementById('users-container');
        const nodesContainer = document.getElementById('nodes-container');
        const userContainer = document.getElementById('user-container');
        const usersElement = document.getElementById('users');
        const nodesElement = document.getElementById('nodes');
        const userElement = document.getElementById('user-info');
        const userIdInput = document.getElementById('userId');

        document.getElementById('connectBtn').addEventListener('click', () => {
            const host = document.getElementById('host').value.trim();
            const port = document.getElementById('port').value.trim();

            if (!host || !port) {
                alert("Please enter a valid host and port");
                return;
            }

            const url = `ws://${host}:${port}/ws`;
            socket = new WebSocket(url);

            socket.onopen = () => {
                console.log(`Connected to WebSocket server at ${url}`);
                requestUsers();
                requestNodes();

                setInterval(() => {
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        requestUsers();
                        requestNodes();
                    }
                }, 5000);
            };

            socket.onmessage = (event) => {
                const data = event.data;
                console.log('Received from server:', data);

                try {
                    const response = JSON.parse(data);
                    if (!response.kind) return;

                    switch (response.kind) {
                        case "users": displayUsers(response); break;
                        case "nodes": displayNodes(response); break;
                        case "user": displayUserInfo(response); break;
                        default: console.log("Unknown response kind:", response.kind);
                    }
                } catch (error) {
                    console.error("Error parsing response:", error);
                }
            };

            socket.onerror = (error) => {
                console.error("WebSocket error:", error);
            };

            socket.onclose = () => {
                console.log("WebSocket connection closed.");
            };
        });

        function requestUsers() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const request = { kind: "get_users", message: "Requesting users" };
                socket.send(JSON.stringify(request));
            }
        }

        function requestNodes() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const request = { kind: "get_nodes", message: "Requesting nodes" };
                socket.send(JSON.stringify(request));
            }
        }

        function requestUserInfo(userId) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const request = {
                    kind: "get_user_info",
                    message: `Requesting info for user ${userId}`,
                    user_id: userId
                };
                socket.send(JSON.stringify(request));
            }
        }

        function displayUsers(state) {
            usersContainer.style.display = 'block';
            usersElement.innerHTML = "";

            let data = state.data;
            if (typeof data === 'string') {
                try { data = JSON.parse(data); } catch {}
            }

            if (Array.isArray(data)) {
                const ul = document.createElement('ul');
                data.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    ul.appendChild(li);
                });
                usersElement.appendChild(ul);
            } else {
                usersElement.textContent = `User count: ${state.len}, Data: ${state.data}`;
            }
        }

        function displayNodes(state) {
            nodesContainer.style.display = 'block';
            nodesElement.innerHTML = "";

            let data = state.data;
            if (typeof data === 'string') {
                try { data = JSON.parse(data); } catch {}
            }

            if (Array.isArray(data)) {
                const ul = document.createElement('ul');
                data.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `Node ID: ${item.uuid}, Hostname: ${item.hostname}, IP: ${item.ipv4}, Status: ${item.status}, Env: ${item.env}`;
                    ul.appendChild(li);
                });
                nodesElement.appendChild(ul);
            } else {
                nodesElement.textContent = state.data;
            }
        }

        function displayUserInfo(userInfo) {
            userContainer.style.display = 'block';
            userElement.textContent = userInfo.data;
        }

        document.getElementById('getUserBtn').addEventListener('click', () => {
            const userId = userIdInput.value.trim();
            if (userId) {
                requestUserInfo(userId);
            } else {
                alert('Please enter a valid user ID');
            }
        });
    </script>
</body>
</html>
